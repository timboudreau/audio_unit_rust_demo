#!/bin/bash

ELEMS=`git --no-pager log -1 '--format=format:%h %H %cd' --date=iso8601-strict --no-color --encoding=utf8`

# e.g. 9bb09ca 9bb09ca25a80aa863c22c08c3b6b9474094107f7 2024-08-28T02:11:04-0400

elemarray=($ELEMS)

STATUS=`git status --porcelain`

if [[ -z "${STATUS}" ]]; then
    repo_status="0"
    human_repo_status="Clean"
else
    repo_status="1"
    human_repo_status="Dirty"
fi

echo "//! This file is generated by the build system to provide git metadata"
echo "//! and will be rebuilt.  Do not edit."
echo
echo /// The short git commit hash, suitable for presenting in the UI if needed
echo "pub const GIT_COMMIT_HASH: &str = \"${elemarray[0]}\";"
echo
echo /// The long git commit hash, for comparison
echo "pub const GIT_COMMIT_LONG_HASH: &str = \"${elemarray[1]}\";"
echo
echo /// The git commit date in strict ISO-8601 format
echo "pub const GIT_COMMIT_DATE: &str = \"${elemarray[2]}\";"
echo
echo '/// The repo status at the time of building - will be one of "clean" or "dirty"'
echo "pub const GIT_CHECKOUT_STATUS : &str = \"${human_repo_status}\";"
echo
echo '/// The repo status as 1 if dirty (uncommitted changes) or 0 if clean'
echo "pub const GIT_CHECKOUT_DIRTY : u8 = ${repo_status};"
echo
echo '/// The version of the crate being built as a Rust string.'
echo "pub const VERSION: &str = env!(\"CARGO_PKG_VERSION\");"
